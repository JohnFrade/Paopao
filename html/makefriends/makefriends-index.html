<!DOCTYPE html>
<html lang="en">

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
        <meta content="yes" name="apple-mobile-web-app-capable">
        <meta content="black" name="apple-mobile-web-app-status-bar-style">
        <meta content="telephone=no" name="format-detection">
        <meta content="email=no" name="format-detection">
        <meta name="x5-page-mode" content="app">
        <link rel="stylesheet" href="../../css/common.css">
        <link rel="stylesheet" href="../../css/footer.css">
        <link rel="stylesheet" href="../../css/makefriends-index.css">
        <title>交友圈</title>
    </head>

    <body>
        <div id="app" v-if="init">
            <header class="header" :class="hideBlockNav">
                <nav class="block-nav global-flex">
                    <ul class="global-flex-1 global-flex global-flex-end">
                        <li v-for="(blockNavItem,blockNavIndex) of blockNav" class="block-item" :class="{'block-active':blockNavIndex === blockIndex}" @click.stop="switchNav(blockNavIndex)">
                            {{blockNavItem}}
                        </li>
                    </ul>
                    <a href="javascript:void(0);" class="global-btn publish-btn">
                        <svg aria-hidden="true" class="icon-publish">
                            <use xlink:href="../../img/global.svg#icon-publish"></use>
                        </svg>
                    </a>
                </nav>
                <nav class="global-flex block-sub-nav global-border global-border-bottom" v-show="blockIndex === 0 && subNavList.length > 0">
                    <ul class="global-flex-1 block-sub-nav-content anim" ref="scrollParent">
                        <li ref="scrollNav" class="block-sub-item font-ellipsis font-ellipsis-1" v-for="(subNavItem,subNavIndex) of subNavList" :class="{'block-sub-active':blockSubIndex === subNavIndex}"
                            @click.stop="switchSubNav(subNavIndex)">{{subNavItem.name}}</li>
                    </ul>
                    <svg aria-hidden="true" class="icon-fold" v-show="hideBlockNav === 'hide-block-nav'" @click.stop="showBlockNav">
                        <use xlink:href=""></use>
                    </svg>
                </nav>
            </header>
            <div id="global-wrapper" ref="wrapper">
                <div class="global-flex global-flex-center global-flex-justify-center refresh-wrapper" :style="{transform:'translateY('+refresh.moveLen+'px)'}" v-show="refresh.show">
                    <div class="icon-refresh-wrapper">
                        <svg aria-hidden="true" class="icon-refresh" :class="{'icon-refresh-load':refresh.release}" v-show="!refresh.load">
                            <use xlink:href="../../img/circle.svg#icon-refresh"></use>
                        </svg>
                        <img src="../../img/loading.svg" class="icon-loading" v-show="refresh.load">
                    </div>
                    <div v-show="!refresh.load">{{refresh.release?'释放刷新':'下拉刷新'}}</div>
                    <div v-show="refresh.load">加载中...</div>
                </div>
                <main class="main" :class="{'main-sub-nav':blockIndex === 0 && subNavList.length > 0 && hideBlockNav !== 'hide-block-nav'}" :style="{transform:'translateY('+refresh.moveLen+'px)'}">
                    <div v-for="(blockNavItem,blockNavIndex) of blockNav" v-show="blockNavIndex === blockIndex">
                        <div class="open-network-wrapper" v-show="!netWorkStatus[blockIndex]">
                            <p>请检查Wifi或者无线局域网是否开启</p>
                        </div>
                        <ul class="circle-list">
                            <!-- v-for="(circleItem,circleIndex) of circleList[blockIndex]" -->
                            <li class="circle-item global-border global-border-bottom" v-for="(circleItem,circleIndex) of [1,2,3]">
                                <div class="global-flex circle-item-top">
                                    <div class="circle-item-avatar">
                                        <img src="https://gss0.bdstatic.com/94o3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike220%2C5%2C5%2C220%2C73/sign=4210e4dcb4096b63951456026d5aec21/9213b07eca806538448187e09ddda144ac3482dd.jpg"
                                                    alt="" class="global-img">
                                    </div>
                                    <div class="global-flex-1 global-flex global-flex-column global-flex-between">
                                        <div class="global-flex global-flex-center">
                                            <h5 class="circle-item-username font-ellipsis font-ellipsis-1">Kimi小可爱</h5>
                                            <div class="global-tag">
                                                VIP
                                                <div class="global-tag-text global-bg-orange">VIP</div>
                                            </div>
                                        </div>
                                        <div class="global-flex">
                                            <!-- 这里要控制不同标签的颜色 需要对返回的数据进行处理 -->
                                            <div class="global-tag circle-type">
                                                健身<div class="global-tag-text">健身</div>
                                            </div>
                                            <div class="global-tag circle-time">
                                                2天前<div class="global-tag-text">2天前</div>
                                            </div>
                                            <div class="global-tag circle-viewer">
                                                浏览5486<div class="global-tag-text">浏览5486</div>
                                            </div>
                                            <div class="global-tag circle-distance global-align-right">
                                                19.7km<div class="global-tag-text">19.7km</div>
                                            </div>
                                        </div>
                                    </div>
                                    <svg class="icon-more" aria-hidden="true" @click="showCircleLayer">
                                        <use xlink:href=""></use>
                                    </svg>
                                </div>
                                <div class="circle-item-content">
                                    <!-- 语音 -->
                                    <button class="circle-item-voice global-flex global-flex-center">
                                        <svg class="icon-microphone" aria-hidden="true">
                                            <use xlink:href="../../img/index.svg#icon-microphone"></use>
                                        </svg>
                                        <svg class="icon-voice" aria-hidden="true">
                                            <use xlink:href="../../img/index.svg#icon-voice"></use>
                                        </svg>
                                        <span class="global-align-right">10s</span>
                                    </button>
                                    <!-- 文字 -->
                                    <div class="circle-item-text">
                                        <!-- font-ellipsis-3 -->
                                        <p class="font-ellipsis font-ellipsis-3">
                                            Lorem ipsum dolor sit amet consectetur adipisicing elit. Placeatvoluptatibus,magnam perspiciatis obcaecati dolore maiores, id libero, enim ipsa rationeducimus cupiditate impedit reiciendis soluta? Iure alias iusto laboredignissimos!Impedit laboriosam natus quidem illum dolorum esse in veritatis eligendiperspiciatis officia, aspernatur maxime. Quae maiores distinctio saeperepellatvitae autem sapiente quam ab. Eveniet repellat maiores accusamus harumtenetur!
                                        </p>
                                        <a href="javascript:;" class="circle-item-read-btn">全文</a>
                                    </div>
                                    <!-- 照片 -->
                                    <ul class="circle-item-ablum">
                                        <!-- 一张图片是ablum-one -->
                                        <!-- 多张图片是ablum-more -->
                                        <li class="ablum-item ablum-more">
                                                <img src="http://img4.duitang.com/uploads/item/201407/26/20140726141237_32faQ.png" alt="">
                                            </li>
                                    </ul>
                                    <!-- 定位 -->
                                    <div class="circle-item-location global-flex global-flex-center">
                                        <svg aria-hidden="true" class="icon-location">
                                            <use xlink:href=""></use>
                                        </svg>
                                        <p class="circle-item-location-text font-ellipsis font-ellipsis-1">广州Four seasonhotel 2701约定你</p>
                                    </div>
                                </div>
                                <div class="global-flex global-flex-between global-flex-center circle-item-bottom">
                                    <div class="global-flex global-flex-center">
                                        <svg aria-hidden="true" class="icon-comment">
                                            <use xlink:link=""></use>
                                        </svg>
                                        2555
                                    </div>
                                    <div class="global-flex global-flex-center anim" @click.stop="like(circleIndex)">
                                        <svg aria-hidden="true" class="icon-like" :class="{ 'icon-liked':testLike}">
                                            <use xlink:href="../../img/circle.svg#icon-like"></use>
                                        </svg>
                                        2955
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <!-- 正在加载 -->
                        <img src="../../img/loading.svg" class="is-loading" v-show="isLoading[blockIndex]">
                        <!-- 加载全部 -->
                        <p class="load-all" v-show="loadingAll[blockIndex]">～暂无更多～</p>
                    </div>
                </main>
            </div>
            <footer id="footer">
                <nav class="global-flex footer-item-wrapper">
                    <a href="javascript:void(0);" class="global-flex-1 footer-item global-flex global-flex-justify-center global-flex-column footer-active" @click.stop="backTop">
                        <svg class="icon-footer" aria-hidden="true">
                            <use xlink:href="../../img/global.svg#icon-index"></use>
                        </svg>
                        <p>首页</p>
                    </a>
                    <a href="../dating.html" class="global-flex-1 footer-item global-flex global-flex-justify-center global-flex-column">
                        <svg class="icon-footer" aria-hidden="true">
                            <use xlink:href="../../img/global.svg#icon-date"></use>
                        </svg>
                        <p>相亲</p>
                    </a>
                    <a href="javascript:void(0);" class="global-flex-1 global-flex global-flex-justify-center global-flex-column footer-item">
                        <svg class="icon-footer" aria-hidden="true">
                            <use xlink:href="../../img/global.svg#icon-rank"></use>
                        </svg>
                        <p>排行榜</p>
                    </a>
                    <a href="../my.html" class="global-flex-1 global-flex global-flex-justify-center global-flex-column footer-item">
                        <svg class="icon-footer" aria-hidden="true">
                            <use xlink:href="../../img/global.svg#icon-my"></use>
                        </svg>
                        <p>我的</p>
                    </a>
                </nav>
            </footer>
            <!-- 拉黑 举报 删除弹层 -->
            <div class="circle-layer" v-show="circleLayer" ref="mask">
                <div class="circle-mask" :class="maskAnim"></div>
                <div class="circle-layer-content" :class="contentAnim">
                    <div v-if="!admin" class="circle-layer-admin">
                        <button class="global-btn circle-layer-item global-border global-border-bottom">删除</button>
                        <button class="global-btn circle-layer-item">拉黑</button>
                    </div>
                    <button class="global-btn circle-layer-item circle-layer-report" v-else>举报</button>
                    <button class="global-btn circle-layer-item circle-layer-cancel" @click.stop="hideCircleLayer">取消</button>
                </div>
            </div>
            <!-- 请求超时 -->
            <div class="tips">请求超时</div>
        </div>
    </body>
    <script src="../../js/jweixin-1.0.0.js"></script>
    <script src="../../js/vue.min.js"></script>
    <script src="../../js/axios.min.js"></script>
    <script src="https://cdn.bootcss.com/vConsole/3.2.0/vconsole.min.js"></script>
    <script type="text/javascript">
        var vConsole = new VConsole();
    </script>
    <script>
        // mock的地址
        var https = 'https://www.easy-mock.com/mock/5c2085ceb9d2c65175338f8c/example/paopao/circle';

        // requestAnimationFrame兼容
        (function () {
            if (!window.requestAnimationFrame) { //兼容requestAnimationFrame
                window.requestAnimationFrame = function (callback) {
                    var currTime = new Date().getTime();
                    var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
                    var timer = window.setTimeout(function () {
                        callback(currTime + timeToCall);
                    }, timeToCall);
                    lastTime = currTime + timeToCall;
                    return timer
                };
            }
            if (!window.cancelAnimationFrame) {
                window.cancelAnimationFrame = function (timer) {
                    clearTimeout(timer)
                };
            }
        })();

        // 滚动防节流函数
        function throttle(interval) {
            var timer, 
                startTime = +new Date();
            return function (fn) {
                var currentTime = +new Date();
                clearTimeout(timer);
                if (currentTime - startTime >= interval) {
                    timer = setTimeout(function(){
                        fn && fn()
                        startTime = currentTime;
                    }, interval)
                } else {
                    timer = setTimeout(function() {
                        fn && fn()
                    },interval)
                }
            }
        }

        var app = new Vue({
            el: '#app',
            data: function () {
                return {
                    init: false,
                    admin: false, // 是否是管理员
                    refresh:{
                        show:false,           // 显示上拉加载
                        moveLen:0,           // 触摸移动长度
                        release:false,       // 满足释放加载
                        load:false           // 松手加载
                    },
                    blockIndex: 0, // 当前板块
                    blockSubIndex: 0, // 当前子版块
                    blockNav: ['全部', '我关注的', '附近的人'], // 板块导航
                    loadingAll: [], // 加载全部
                    isLoading: [], // 正在加载
                    pageIndex: [], // 页数
                    subNavList: [], // 子导航
                    circleList: [], // 交友圈列表
                    netWorkStatus:[],// 网络状态
                    location:{ // 附近的人坐标
                        lat:0,
                        lng:0
                    },
                    hideBlockNav:'', // 隐藏导航的class
                    testLike:false, // 点赞
                    circleLayer: false, // 蒙层开关
                    maskAnim: '', // 蒙层动画
                    contentAnim: '', // 蒙层内容动画
                }
            },
            watch: {
                blockIndex: {
                    handler: function (val, oldVal) {
                        if(this.circleList[this.blockIndex].length == 0){
                            this.loadCircleItem()
                        }
                    }
                },
                blockSubIndex: {
                    handler: function (val, oldVal) {
                        this.$set(this.circleList,0,[]);
                        this.$set(this.isLoading, 0, false);
                        this.$set(this.loadingAll, 0, false);
                        this.$set(this.pageIndex, 0, 1)
                        this.loadCircleItem()
                    }
                },
                circleLayer: {
                    handler: function (val, oldVal) {
                        if (val) {
                            this.maskAnim = 'fadeIn'
                            this.contentAnim = 'sliderFromDown'
                        } else if (oldVal) {
                            this.maskAnim = ''
                            this.contentAnim = ''
                        }
                    }
                }
            },
            created() {
                this.initData()
                this.getSubNavList()
            },
            mounted() {
                var self = this
                this.init = true;
                // $refs绑定数据延时
                setTimeout(() =>{
                    self.globalScroll()
                    self.disabledMaskMove()
                },168)
            },
            methods: {
                // 全局滚动
                globalScroll:function() {
                    var scrollTop = 0,
                        timer = 0,
                        startY = 0,
                        self = this, 
                        wrapper = this.$refs.wrapper;

                    var globalScroll = throttle(30);

                    wrapper.addEventListener('touchstart',function(e){
                        if(self.circleList[self.blockIndex].length === 0 && !self.netWorkStatus[self.blockIndex]){
                            timer = +new Date();
                            startY = e.changedTouches[0].pageY;
                        }
                    },false)
                    wrapper.addEventListener('touchmove',function(e){
                        if(self.circleList[self.blockIndex].length === 0 && !self.netWorkStatus[self.blockIndex]){
                            var deltaY = (e.changedTouches[0].pageY - startY);
                            if(wrapper.offsetTop === 0 && deltaY > 0){
                                if(+new Date() - timer >= 16.6 && !self.refresh.release){
                                    self.refresh.show = true;
                                    deltaY = deltaY>=68?68:deltaY;
                                    if(self.blockIndex === 0){
                                        if(self.hideBlockNav === 'hide-block-nav'){
                                            self.refresh.moveLen = deltaY / 2
                                        }else{
                                            self.refresh.moveLen = deltaY * 1.5;
                                        }
                                    }else{
                                        self.refresh.moveLen = deltaY / 2;
                                    }

                                    if(deltaY >= 68){
                                        self.refresh.release = true;
                                    }else{
                                        self.refresh.moveLen = 0
                                    }
                                }
                            }
                        }
                    },false)
                    // 释放结束
                    wrapper.addEventListener('touchend',function(e){
                        if(self.circleList[self.blockIndex].length === 0 && !self.netWorkStatus[self.blockIndex]){
                            if(self.refresh.release && !self.refresh.load){
                                self.refresh.load = true
                                // self.loadCircleItem()
                                setTimeout(() => {
                                    self.refresh.moveLen = 0;
                                    self.refresh.release = false;
                                    self.refresh.load = false;
                                    self.refresh.show = false;
                                },1500)
                            }
                        }
                    },false)

                    wrapper.addEventListener('scroll', function (e) {
                        globalScroll(function(){
                            // 子导航存在搜索板块导航
                            if(self.blockIndex === 0 && self.subNavList.length > 0){
                                if(e.target.scrollTop - scrollTop > 10 && self.hideBlockNav !== 'hide-block-nav'){
                                    self.hideBlockNav = 'hide-block-nav'
                                }
                                scrollTop = e.target.scrollTop
                            }
                            if(e.target.scrollTop + e.target.clientHeight + 68 >= e.target.scrollHeight) {
                                self.loadCircleItem()
                            }
                        })
                    },false)
                },
                // 返回顶部
                backTop:function() {
                    var self = this;
                    var wrapper = this.$refs.wrapper;
                    function getScrollAnimNum(scrollTop){
                        scrollTop = scrollTop >= 12000?12000:scrollTop;
                        switch (true) {
                            case scrollTop >= 8000:
                                return 400
                                break;
                            case scrollTop >= 5000 && scrollTop < 8000:
                                return 300
                                break;
                            case scrollTop >= 1500 && scrollTop < 5000:
                                return 150
                                break;
                            default: 
                                return 100
                        }
                    }
                    var timer = requestAnimationFrame(function fn() {
                        if(wrapper.scrollTop > 0){
                            wrapper.scrollTop -= getScrollAnimNum(wrapper.scrollTop);
                            requestAnimationFrame(fn)
                        }else{
                            wrapper.scrollTop = 0
                            cancelAnimationFrame(timer)
                        }
                    })
                },
                initData: function () {
                    var self = this;
                    this.blockNav.forEach(function (item, index) {
                        self.netWorkStatus.push(true)
                        self.isLoading.push(false)
                        self.loadingAll.push(false)
                        self.pageIndex.push(1)
                        self.circleList.push([])
                    })
                },
                // 获取子版块导航 
                getSubNavList: function () {
                    var self = this;
                    axios.get(https + '?type=99').then(function (res) {
                        if (res.data.data.success) {
                            self.subNavList = res.data.data.subNavList;
                            // axios异步取数据有延时
                            setTimeout(function(){
                                self.initSubNav('offsetLeft');
                            },168)
                        }
                    }).catch(function (err) {
                        console.log(err);
                    })
                },
                // 初始化子版块导航
                initSubNav: function (attr) {
                    if (this.subNavList.length > 0) {
                        this.subNavScrollArr = this.$refs.scrollNav.reduce(function (arr, cur, index) {
                            arr.push(cur[attr]);
                            return arr
                        }, [])
                    }
                },
                // 切换板块
                switchNav: function (val) {
                    if (this.blockIndex !== val) {
                        this.blockIndex = val
                    }
                },
                showBlockNav() {
                    this.hideBlockNav = ''
                },
                // 检测定位
                getLocation() {
                    var self = this;
                    wx.getLocation({
                        type: 'wgs84',
                        success: function(res){
                            console.log('success')
                            console.log(res)
                            self.location = {
                                lat:res.latitude,
                                lng:res.longitude
                            }
                        },
                        fail: function(res) {
                            console.log('fail')
                            console.log(res)
                        }
                    })
                },
                // 切换子版块
                switchSubNav: function (val) {
                    if (this.subNavIndex !== val) {
                        this.navScroll('scrollLeft', val, this.blockSubIndex)
                        this.blockSubIndex = val
                    }
                },
                // 导航滚动
                navScroll: function (attr, index, before) {
                    var self = this;
                    var startPosition = this.subNavScrollArr[before-2] || 0;
                    var curPosition = this.$refs.scrollParent;
                    var direction = index > before ? 1 : -1;
                    var rate = (index - before) / 2;
                    var speedRange = 6.85
                    var startAnimation = function (endPosition) {
                        var timer = requestAnimationFrame(function fn() {
                            startPosition += ((endPosition - startPosition) * direction >= 30 ?
                                (6.25 * rate) : 3.25 * direction)
                            if ((direction == 1 && startPosition <= endPosition) || (direction ==
                                    -1 && startPosition >= endPosition)) {
                                curPosition[attr] = startPosition;
                                timer = requestAnimationFrame(fn);
                            } else {
                                curPosition[attr] = endPosition;
                                cancelAnimationFrame(timer);
                            }
                        })
                    }
                    if(direction === 1 && index > 2){
                        // console.log(startPosition)
                        // console.log(index)
                        // console.log(this.subNavScrollArr[index - 2])
                        startAnimation(this.subNavScrollArr[index - 2])
                    } else if (direction === -1) {
                        startAnimation(this.subNavScrollArr[index - 2] >= 0 ? this.subNavScrollArr[index -
                            2] : 0)
                    }
                },
                // 加载交友圈列表
                loadCircleItem: function () {
                    var self = this;
                    wx.getNetworkType({
                        success: function (res) {
                            if(!self.loadingAll[self.blockIndex] && !self.isLoading[self.blockIndex]){
                                if(self.blockIndex === 2 && self.location.lat === 0 && self.location.lng === 0){

                                }else{
                                    self.$set(self.isLoading,self.blockIndex,true);
                                    self.$set(self.netWorkStatus,self.blockIndex,true)
                                    /*
                                        axios.get()
                                    */
                                }
                            }
                        },
                        fail: function (res) {
                            // 首次加载会出现无网的图
                            if(res.errMsg === 'getNetworkType:fail' && self.circleList[self.blockIndex].length === 0){
                                self.$set(self.netWorkStatus,self.blockIndex,false)
                            }
                        }
                    });
                    // this.getLocation()
                },
                // 点赞
                like:function(index){
                    console.log(index)
                    this.testLike = true;
                    /*
                        var circleItem = this.circleList[this.blockIndex][index]; 
                        axios.post().then(function(response){
                            this.$set(circleItem,'like',!circleItem)
                        }).catch(function(err){
                            console.log(err)
                        })
                    */
                },
                disabledMaskMove() {
                    this.$refs.mask.addEventListener('touchmove',function(e){
                        e.preventDefault()
                    })
                },
                showCircleLayer() {
                    this.circleLayer = !this.circleLayer
                },
                // 拉黑 删除 举报执行此回调
                hideCircleLayer() {
                    this.maskAnim = 'fadeOut';
                    this.contentAnim = 'sliderOutDown'
                    setTimeout(() => {
                        this.circleLayer = false
                    }, 320)
                }
            }
        })
    </script>

</html>