<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <meta name="x5-page-mode" content="app">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/ai-share.css">
    <title>脱单分享</title>
</head>
<body>
    <div id="app" v-if="init">
        <div class="poster-wrp">
            <canvas id="poster"></canvas>
            <img :src="imgSrc" class="poster-img">
        </div>
        <h1 class="poster-tips">长按保存图片，分享赚钱</h1>
    </div>
</body>
<script src="../../js/vue.min.js"></script>
<script>
    // 获取canvas的尺寸
    function getCanvasSize() {
        var u = navigator.userAgent,
            winW = document.documentElement.clientWidth;
            winH = document.documentElement.clientHeight;        
        winW = winW >= 640 ? 640 : winW;
        winH = winH >= 960 ? 960 : winH;
        winH = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?winH*1.08:winH;
        var outline = Math.round(winW * 0.032);
        return {
            outline:outline*2,
            w: winW * 2,
            h: winH * 2
        }
    }

    // 获取缩放比例
    function getBasePixal() {
        var winW = document.documentElement.clientWidth;
        winW = winW >= 640 ? 640 : winW;
        if (winW >= 320 && winW < 360) {
            return 10
        } else if (winW >= 360 && winW < 414) {
            return 12
        } else if (winW >= 414 && winW < 480) {
            return 14
        } else if (winW >= 480) {
            return 16
        }
    }

    // 绘制图片
    function preLoadImg(imgSrc) {
        var newImg = new Image();
        newImg.src = imgSrc;
        return function(fn) {
            newImg.onload = function(e) {
                fn(newImg)
            }
        }
    }


    var app = new Vue({
        el:'#app',
        data:function() {
            return{
                init:false,
                imgSrc:''
            }
        },
        mounted:function() {
            this.init = true;            
        },
        watch:{
            init:function(val){
                if(val){
                    this.$nextTick(function(){
                        this.drawPoster()
                    })
                }
            }
        },
        methods:{
            //  绘制海报
            drawPoster:function(content) {
                var parent = getCanvasSize(),
                    fontSize = getBasePixal();   // 字体的缩放系数
                    console.log(parent)
                var canvas = document.getElementById("poster");
                console.log(canvas)
                var ctx = canvas.getContext("2d");
                canvas.setAttribute("width", parent.w);
                canvas.setAttribute("height", parent.h);
                canvas.style.width = (parent.w / 2) + 'px';
                canvas.style.height = (parent.h / 2) + 'px';

                // 清空画布
                ctx.clearRect(0, 0, parent.w, parent.h)

                // 开始绘制
                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 0, parent.w, parent.h);

                // 绘制边框
                ctx.lineWidth = parent.outline;

                ctx.strokeStyle = '#7A5BFF';
                ctx.strokeRect(0,0,parent.w, parent.h)

                // 绘制banner
                preLoadImg('https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1554204405883&di=6a151b58a41e0d4bd3f4ed9e306afabb&imgtype=0&src=http%3A%2F%2Fimg.zcool.cn%2Fcommunity%2F01b0555541c143000001a64b78e301.jpg%401280w_1l_2o_100sh.jpg')(function(img){
                    ctx.drawImage(img,parent.outline*.5, parent.outline*.5, parent.w-parent.outline, parent.h*.55319148936);
                })
                // 绘制头像
                preLoadImg('http://img5.duitang.com/uploads/item/201408/14/20140814165959_VCtan.thumb.700_0.png')(function(img){
                    function drawAvatar(ctx,img,x,y,r){
                        var d = 2 * r;
                        var cx = x + r;
                        var cy = y + r;
                        ctx.beginPath();
                        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                        ctx.clip();
                        ctx.drawImage(img, x, y, d, d);
                        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                        ctx.save();
                        // ctx.strokeStyle = '#orange';
                        ctx.fillStyle = '#orange';
                        ctx.strokeWidth = 2
                        ctx.arc(100,400,100,0*Math.PI/180,120*Math.PI/180);
                        ctx.stroke();
                    }
                    drawAvatar(ctx,img,(parent.w - 10*fontSize - parent.outline*4)/2,parent.h*.0625,10*fontSize)
                })
                

                // 绘制用户名
                var test = '哈哈哈哈哈哈';
                ctx.font = fontSize * 2 + 'px PingFang SC';
                ctx.fillStyle = '#fff';
                ctx.fillText(test, (parent.w - ctx.measureText(test).width) / 2,0.2229166666667 * parent.h);

                // 分数

                // 星星

                // 标题

                // 副标题

                // 二维码

                // 指纹
                
                var src = canvas.toDataURL('image/jpeg', 1);
                this.imgSrc = src;
            }
        }
    })
</script>
</html>